<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.80.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Joway><meta property=og:url content=https://blog.joway.io/posts/golang-fastrand/><link rel=canonical href=https://blog.joway.io/posts/golang-fastrand/><link rel=dns-prefetch href=https://cdn.jsdelivr.net/gh/joway/blog><link rel=apple-touch-icon href=/logo.png><link rel=icon href=/logo.png><link rel=shortcut href=/logo.png><link rel=alternate type=application/atom+xml href=https://blog.joway.io/index.xml title="Joway's Blog"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.joway.io\/"},"articleSection":"posts","name":"Golang rand 库锁竞争优化","headline":"Golang rand 库锁竞争优化","description":"背景 最近在实现一个随机负载均衡器的时候发现一个问题，在高并发的情况下，官方标准库 rand.Intn() 性能会急剧下降。翻了下实现以后才发现它内部居然是全局共享了同一个 globalRand 对象。\n一段测试代码：\nfunc BenchmarkGlobalRand(b *testing.B) { b.RunParallel(func(pb *testing.PB) { for pb.Next() { rand.Intn(100) } }) } func BenchmarkCustomRand(b *testing.B) { b.RunParallel(func(pb *testing.PB) { rd := rand.New(rand.NewSource(time.Now().Unix())) for pb.Next() { rd.Intn(100) } }) } 输出：\nBenchmarkGlobalRand BenchmarkGlobalRand-8 18075486 66.1 ns\/op BenchmarkCustomRand BenchmarkCustomRand-8 423686118 2.38 ns\/op 解决思路 最理想对情况是可以在每个 goroutine 内创建一个私有的 rand.Rand 对象，从而实现真正的无锁。\n但在很多其他场景下，我们并不能直接控制调用我们的 goroutine，又或者 goroutine 数量过多以至于无法承受这部分内存成本。\n此时的一个思路是使用 sync.Pool 来为 rand.Source 创建一个池，当多线程并发读写时，优先从自己当前 P 中的 poolLocal 中获取，从而减少锁的竞争。同时由于只是用 pool 扩展了原生的 rngSource 对象，所以可以兼容其 rand.","inLanguage":"en-US","author":"Joway","creator":"Joway","publisher":"Joway","accountablePerson":"Joway","copyrightHolder":"Joway","copyrightYear":"2020","datePublished":"2020-12-17 00:00:00 \u002b0000 UTC","dateModified":"2020-12-17 00:00:00 \u002b0000 UTC","url":"https:\/\/blog.joway.io\/posts\/golang-fastrand\/","keywords":[]}</script><title>Golang rand 库锁竞争优化</title><meta property=og:title content="Golang rand 库锁竞争优化"><meta property=og:type content=article><meta property=og:description content="背景 最近在实现一个随机负载均衡器的时候发现一个问题，在高并发的情况下，官方标准库 rand.Intn() 性能会急剧下降。翻了下实现以后才发现它内部居然是全局共享了同一个 globalRand 对象。
一段测试代码：
func BenchmarkGlobalRand(b *testing.B) { b.RunParallel(func(pb *testing.PB) { for pb.Next() { rand.Intn(100) } }) } func BenchmarkCustomRand(b *testing.B) { b.RunParallel(func(pb *testing.PB) { rd := rand.New(rand.NewSource(time.Now().Unix())) for pb.Next() { rd.Intn(100) } }) } 输出：
BenchmarkGlobalRand BenchmarkGlobalRand-8 18075486 66.1 ns/op BenchmarkCustomRand BenchmarkCustomRand-8 423686118 2.38 ns/op 解决思路 最理想对情况是可以在每个 goroutine 内创建一个私有的 rand.Rand 对象，从而实现真正的无锁。
但在很多其他场景下，我们并不能直接控制调用我们的 goroutine，又或者 goroutine 数量过多以至于无法承受这部分内存成本。
此时的一个思路是使用 sync.Pool 来为 rand.Source 创建一个池，当多线程并发读写时，优先从自己当前 P 中的 poolLocal 中获取，从而减少锁的竞争。同时由于只是用 pool 扩展了原生的 rngSource 对象，所以可以兼容其 rand."><meta name=description content="背景 最近在实现一个随机负载均衡器的时候发现一个问题，在高并发的情况下，官方标准库 rand.Intn() 性能会急剧下降。翻了下实现以后才发现它内部居然是全局共享了同一个 globalRand 对象。
一段测试代码：
func BenchmarkGlobalRand(b *testing.B) { b.RunParallel(func(pb *testing.PB) { for pb.Next() { rand.Intn(100) } }) } func BenchmarkCustomRand(b *testing.B) { b.RunParallel(func(pb *testing.PB) { rd := rand.New(rand.NewSource(time.Now().Unix())) for pb.Next() { rd.Intn(100) } }) } 输出：
BenchmarkGlobalRand BenchmarkGlobalRand-8 18075486 66.1 ns/op BenchmarkCustomRand BenchmarkCustomRand-8 423686118 2.38 ns/op 解决思路 最理想对情况是可以在每个 goroutine 内创建一个私有的 rand.Rand 对象，从而实现真正的无锁。
但在很多其他场景下，我们并不能直接控制调用我们的 goroutine，又或者 goroutine 数量过多以至于无法承受这部分内存成本。
此时的一个思路是使用 sync.Pool 来为 rand.Source 创建一个池，当多线程并发读写时，优先从自己当前 P 中的 poolLocal 中获取，从而减少锁的竞争。同时由于只是用 pool 扩展了原生的 rngSource 对象，所以可以兼容其 rand."><meta property=og:locale content=en-us><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/joway/blog/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/index.css><link href=https://cdn.jsdelivr.net/gh/joway/blog/index.xml rel=alternate type=application/rss+xml title="Joway's Blog"><link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53624533-8"></script><script src=https://cdn.jsdelivr.net/gh/joway/homepage/analytics.js></script><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=signatures><a href=/>Joway Wang</a></div></header><div class="row end-xs"></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Golang rand 库锁竞争优化</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2020-12-17 00:00:00 UTC">17 Dec 2020</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://joway.io/>@Joway</a></div></div></div></header><div class="post-content markdown-body"><h1 id=背景>背景</h1><p>最近在实现一个随机负载均衡器的时候发现一个问题，在高并发的情况下，官方标准库 <code>rand.Intn()</code> 性能会急剧下降。翻了下实现以后才发现它内部居然是全局共享了同一个 <a href=https://github.com/golang/go/blob/master/src/math/rand/rand.go#L293>globalRand</a> 对象。<p>一段测试代码：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>BenchmarkGlobalRand</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>B</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunParallel</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pb</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PB</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>pb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Next</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
         <span style=color:#000>rand</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Intn</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#000;font-weight:700>}</span>
   <span style=color:#000;font-weight:700>})</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>BenchmarkCustomRand</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>b</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>B</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>b</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunParallel</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pb</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PB</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
      <span style=color:#000>rd</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>rand</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rand</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewSource</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Unix</span><span style=color:#000;font-weight:700>()))</span>
      <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>pb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Next</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
         <span style=color:#000>rd</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Intn</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span>
      <span style=color:#000;font-weight:700>}</span>
   <span style=color:#000;font-weight:700>})</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>输出：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#000>BenchmarkGlobalRand</span>
<span style=color:#000>BenchmarkGlobalRand</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>8</span> <span style=color:#0000cf;font-weight:700>18075486</span> <span style=color:#0000cf;font-weight:700>66.1</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>op</span>
<span style=color:#000>BenchmarkCustomRand</span>
<span style=color:#000>BenchmarkCustomRand</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>8</span> <span style=color:#0000cf;font-weight:700>423686118</span> <span style=color:#0000cf;font-weight:700>2.38</span> <span style=color:#000>ns</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>op</span>
</code></pre></div><h1 id=解决思路>解决思路</h1><p>最理想对情况是可以在每个 goroutine 内创建一个私有的 rand.Rand 对象，从而实现真正的无锁。<p>但在很多其他场景下，我们并不能直接控制调用我们的 goroutine，又或者 goroutine 数量过多以至于无法承受这部分内存成本。<p>此时的一个思路是使用 <code>sync.Pool</code> 来为 <code>rand.Source</code> 创建一个池，当多线程并发读写时，优先从自己当前 P 中的 poolLocal 中获取，从而减少锁的竞争。同时由于只是用 pool 扩展了原生的 rngSource 对象，所以可以兼容其 rand.Rand 下的所有接口调用。<p>基于这个思路，实现了一个 <a href=https://github.com/joway/fastrand>fastrand</a> 库放到了 github。<p>从 benchmark 中可以看到性能提升显著，在并发条件下，比原生全局 rand 快了大约 8 倍.<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback>BenchmarkStandardRand
BenchmarkStandardRand-8                         60870416                19.1 ns/op             0 B/op          0 allocs/op
BenchmarkFastRand
BenchmarkFastRand-8                             100000000               10.7 ns/op             0 B/op          0 allocs/op
BenchmarkStandardRandWithConcurrent
BenchmarkStandardRandWithConcurrent-8           18058663                67.8 ns/op             0 B/op          0 allocs/op
BenchmarkFastRandWithConcurrent
BenchmarkFastRandWithConcurrent-8               132542940                8.79 ns/op            0 B/op          0 allocs/op
</code></pre></div></div><div class="row middle-xs"><div class=col-xs-12><div class=post-category><a href=/categories/tech/>Tech</a></div></div></div><div class=row><div class=col-xs-12><br><br><p>Subscribe：<a target=_blank href=https://mailchi.mp/a1a0d59e7a19/joway><b>Mailchimp</b></a></p><br><a rel=license href=http://creativecommons.org/licenses/by-nc-nd/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://blog.joway.io/images/cc.png></a></div></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var d=document,s=d.createElement("script");s.src="https://joway.disqus.com/embed.js";s.setAttribute("data-timestamp",+new Date());(d.head||d.body).appendChild(s);})();});</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer><div class=site-footer-item><a href=https://mailchi.mp/a1a0d59e7a19/joway target=_blank>Subscribe</a></div><div class=site-footer-item><a href=/index.xml target=_blank>RSS</a></div><div class=site-footer-item><a href=/presentations target=_blank>Slides</a></div><div class=site-footer-item><a href=/travel target=_blank>Travel</a></div><div class=site-footer-item><a href=https://joway.io target=_blank>About</a></div></div></div></div></article><script src=https://cdn.jsdelivr.net/gh/joway/blog/js/highlight.pack.js></script><script src=https://cdn.jsdelivr.net/gh/joway/blog/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById('article')});</script>