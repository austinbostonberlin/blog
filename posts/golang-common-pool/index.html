<!doctype html><html lang=en><meta charset=utf-8><meta name=generator content="Hugo 0.80.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content=Joway><meta property=og:url content=https://blog.joway.io/posts/golang-common-pool/><link rel=canonical href=https://blog.joway.io/posts/golang-common-pool/><link rel=dns-prefetch href=https://cdn.jsdelivr.net/gh/joway/blog><link rel=apple-touch-icon href=/logo.png><link rel=icon href=/logo.png><link rel=shortcut href=/logo.png><link rel=alternate type=application/atom+xml href=https://blog.joway.io/index.xml title="Joway's Blog"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.joway.io\/"},"articleSection":"posts","name":"Pond: Golang 通用对象池","headline":"Pond: Golang 通用对象池","description":"为什么需要通用对象池 在实际生产环境中，我们经常会遇到需要多线程共享同一堆对象的场景，例如常见的RPC、数据库连接池，大内存对象池，以及线程池等。这些池化对象的需求其实有很多重叠的地方，主要分以下几个方面：\n 基础设置：  最大容量 创建\/校验\/删除对象的回调方法 申请对象时，已满时是否阻塞   多重驱逐策略：  驱逐闲置对象 驱逐无效对象   预创建对象  为避免重复编码，所以设计了 Pond 这样一个能够支撑多种使用场景的通用对象池。另外，在 Pond 的基础上，还实现了 Goroutine 池库： Hive。\n使用方式 \/\/example type conn struct { addr string } func main() { ctx := context.Background() cfg := pond.NewDefaultConfig() cfg.MinIdle = 1 cfg.ObjectCreateFactory = func(ctx context.Context) (interface{}, error) { return \u0026amp;conn{addr: \u0026#34;127.0.0.1\u0026#34;}, nil } cfg.ObjectValidateFactory = func(ctx context.Context, object interface{}) bool { c := object.(*conn) return c.","inLanguage":"en-US","author":"Joway","creator":"Joway","publisher":"Joway","accountablePerson":"Joway","copyrightHolder":"Joway","copyrightYear":"2021","datePublished":"2021-01-23 00:00:00 \u002b0000 UTC","dateModified":"2021-01-23 00:00:00 \u002b0000 UTC","url":"https:\/\/blog.joway.io\/posts\/golang-common-pool\/","keywords":[]}</script><title>Pond: Golang 通用对象池 - Joway's Blog</title><meta property=og:title content="Pond: Golang 通用对象池 - Joway's Blog"><meta property=og:type content=article><meta property=og:description content='为什么需要通用对象池 在实际生产环境中，我们经常会遇到需要多线程共享同一堆对象的场景，例如常见的RPC、数据库连接池，大内存对象池，以及线程池等。这些池化对象的需求其实有很多重叠的地方，主要分以下几个方面：
 基础设置：  最大容量 创建/校验/删除对象的回调方法 申请对象时，已满时是否阻塞   多重驱逐策略：  驱逐闲置对象 驱逐无效对象   预创建对象  为避免重复编码，所以设计了 Pond 这样一个能够支撑多种使用场景的通用对象池。另外，在 Pond 的基础上，还实现了 Goroutine 池库： Hive。
使用方式 //example type conn struct { addr string } func main() { ctx := context.Background() cfg := pond.NewDefaultConfig() cfg.MinIdle = 1 cfg.ObjectCreateFactory = func(ctx context.Context) (interface{}, error) { return &conn{addr: "127.0.0.1"}, nil } cfg.ObjectValidateFactory = func(ctx context.Context, object interface{}) bool { c := object.(*conn) return c.'><meta name=description content='为什么需要通用对象池 在实际生产环境中，我们经常会遇到需要多线程共享同一堆对象的场景，例如常见的RPC、数据库连接池，大内存对象池，以及线程池等。这些池化对象的需求其实有很多重叠的地方，主要分以下几个方面：
 基础设置：  最大容量 创建/校验/删除对象的回调方法 申请对象时，已满时是否阻塞   多重驱逐策略：  驱逐闲置对象 驱逐无效对象   预创建对象  为避免重复编码，所以设计了 Pond 这样一个能够支撑多种使用场景的通用对象池。另外，在 Pond 的基础上，还实现了 Goroutine 池库： Hive。
使用方式 //example type conn struct { addr string } func main() { ctx := context.Background() cfg := pond.NewDefaultConfig() cfg.MinIdle = 1 cfg.ObjectCreateFactory = func(ctx context.Context) (interface{}, error) { return &conn{addr: "127.0.0.1"}, nil } cfg.ObjectValidateFactory = func(ctx context.Context, object interface{}) bool { c := object.(*conn) return c.'><meta property=og:locale content=en-us><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/joway/blog/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/index.css><link href=https://cdn.jsdelivr.net/gh/joway/blog/index.xml rel=alternate type=application/rss+xml title="Joway's Blog"><link href="https://fonts.googleapis.com/css?family=Arvo|Permanent+Marker|Bree+Serif" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53624533-8"></script><script src=https://cdn.jsdelivr.net/gh/joway/homepage/analytics.js></script><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=signatures><a href=/>Joway Wang</a></div></header><div class="row end-xs"></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Pond: Golang 通用对象池</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2021-01-23 00:00:00 UTC">23 Jan 2021</time></div><div class=col-xs-6><div class=post-author><a target=_blank href=https://joway.io/>@Joway</a></div></div></div></header><div class="post-content markdown-body"><h2 id=为什么需要通用对象池>为什么需要通用对象池</h2><p>在实际生产环境中，我们经常会遇到需要多线程共享同一堆对象的场景，例如常见的RPC、数据库连接池，大内存对象池，以及线程池等。这些池化对象的需求其实有很多重叠的地方，主要分以下几个方面：<ol><li>基础设置：<ol><li>最大容量<li>创建/校验/删除对象的回调方法<li>申请对象时，已满时是否阻塞</ol><li>多重驱逐策略：<ol><li>驱逐闲置对象<li>驱逐无效对象</ol><li>预创建对象</ol><p>为避免重复编码，所以设计了 <a href=https://github.com/joway/pond>Pond</a> 这样一个能够支撑多种使用场景的通用对象池。另外，在 Pond 的基础上，还实现了 Goroutine 池库： <a href=https://github.com/joway/hive>Hive</a>。<h2 id=使用方式>使用方式</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>//example
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>conn</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>addr</span> <span style=color:#204a87;font-weight:700>string</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>ctx</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>()</span>
	<span style=color:#000>cfg</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>pond</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewDefaultConfig</span><span style=color:#000;font-weight:700>()</span>
	<span style=color:#000>cfg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MinIdle</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span>
	<span style=color:#000>cfg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectCreateFactory</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>addr</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;127.0.0.1&#34;</span><span style=color:#000;font-weight:700>},</span> <span style=color:#204a87;font-weight:700>nil</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000>cfg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectValidateFactory</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#204a87;font-weight:700>bool</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>object</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>addr</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#34;&#34;</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000>cfg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectDestroyFactory</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>object</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>addr</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;&#34;</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000>p</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>pond</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cfg</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fatal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>obj</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BorrowObject</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fatal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ReturnObject</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;get conn: %v\n&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>obj</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>addr</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=使用细则>使用细则</h2><h3 id=lifo-驱逐策略>LIFO 驱逐策略</h3><p>当前采用 LIFO 的驱逐策略，保证永远优先使用最常被使用的对象。之所以不采用 FIFO 是因为我们只有让热门的对象尽可能保持热门，而不是均衡每个对象的使用频率，才能够保证最大程度筛选出不常用的对象从而使其被驱逐。<h3 id=避免频繁驱逐>避免频繁驱逐</h3><p>某些情况下会出现不停创建新的对象，到了驱逐时间又被立马销毁的情况，从而使得对象池的大小出现不必要的频繁变动。这里我们可以通过 <code>MinIdleTime</code> 配置最小闲置时间，保证只有当对象闲置超过该时间后，才可能被驱逐。<h3 id=对象校验>对象校验</h3><p>有一种情况是，一开始在池子里创建好了几个对象，但是当用户实际去取出来的时候，发现该对象其实已经被关闭或者失效了。所以在 Pool 内部需要每次取的对象都经过一次校验，如果校验不通过，则销毁对象，再次尝试去取。该策略还能保证当出现部分节点抖动时，会尽可能剔除不可用节点，提供稳定的对象。<p>同时为了避免当一些灾难情况下，永远无法成功创建对象（例如下游节点完全宕机），我们还需要设置 <code>MaxValidateAttempts</code> 以避免出现恶性循环。<h3 id=预创建对象>预创建对象</h3><p>在默认情况下，我们会在每次取对象的时候，判断是否需要创建新的，如需要再取实时创建。但如果创建操作比较费时，我们会希望在条件允许的情况下，池子里能够预留一部分空闲对象，以供未来调用。<code>MinIdle</code> 参数用以确保池子内最小能够拥有的空闲对象数。<h3 id=超时取消>超时取消</h3><p>默认配置下，每次取对象如果当前池已满，且没有闲置对象，会阻塞住，直到能够获取到可用对象为止。我们使用 context 来实现获取超时取消的逻辑。一旦当触发 <code>ctx.Done()</code> 时候，会直接 return，并返回 <code>ctx.Err()</code> 。<h2 id=高级扩展>高级扩展</h2><p>Pond 是一个通用对象池，在此基础上，我们可以非常简单地实现诸如连接池，goroutine 池等多重应用。<p>以下示例展示了如何使用 Pond 创建一个简单的 goroutine 池：<h3 id=实现-worker-对象>实现 Worker 对象</h3><p>Worker 结构体用以封装单个 goroutine：<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Worker</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>jobs</span> <span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>Job</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>NewWorker</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Worker</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>Worker</span><span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>jobs</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87>make</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#000>Job</span><span style=color:#000;font-weight:700>),</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>go</span> <span style=color:#000>w</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Run</span><span style=color:#000;font-weight:700>()</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>w</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Worker</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Submit</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>task</span> <span style=color:#000>Task</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>callback</span> <span style=color:#000>Callback</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>w</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>jobs</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>Job</span><span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>task</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>task</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#000>callback</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>callback</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Worker</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Run</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>job</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000>w</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>jobs</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>job</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>task</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>job</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>task</span><span style=color:#000;font-weight:700>()</span>
		<span style=color:#000;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>job</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>callback</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>job</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>callback</span><span style=color:#000;font-weight:700>()</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Worker</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Close</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87>close</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>jobs</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=池化-worker-对象>池化 Worker 对象</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=color:#000>pConfig</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>pond</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewDefaultConfig</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000>pConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxSize</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Size</span>
<span style=color:#000>pConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Nonblocking</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Nonblocking</span>
<span style=color:#000>pConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectCreateFactory</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>NewWorker</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#000>pConfig</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ObjectDestroyFactory</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>object</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>w</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>object</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Worker</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#000>w</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Close</span><span style=color:#000;font-weight:700>()</span>
    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#000>workers</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>pond</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pConfig</span><span style=color:#000;font-weight:700>)</span>

<span style=color:#000>object</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>workers</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BorrowObject</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>worker</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>object</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Worker</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000>worker</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Submit</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>//do some task
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>},</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic>// when task finished, return object
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>workers</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ReturnObject</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>object</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>})</span>
</code></pre></div></div><div class="row middle-xs"><div class=col-xs-12><div class=post-category><a href=/categories/tech/>Tech</a></div></div></div><div class=row><div class=col-xs-12><br><br><p>Subscribe：<a target=_blank href=https://mailchi.mp/a1a0d59e7a19/joway><b>Mailchimp</b></a></p><br><a rel=license href=http://creativecommons.org/licenses/by-nc-nd/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://blog.joway.io/images/cc.png></a></div></div><div style=height:50px></div><div class=post-comments><div id=disqus_thread></div><script>window.addEventListener("load",()=>{(function(){var d=document,s=d.createElement("script");s.src="https://joway.disqus.com/embed.js";s.setAttribute("data-timestamp",+new Date());(d.head||d.body).appendChild(s);})();});</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div><div class=site-footer><div class=site-footer-item><a href=https://mailchi.mp/a1a0d59e7a19/joway target=_blank>Subscribe</a></div><div class=site-footer-item><a href=/index.xml target=_blank>RSS</a></div><div class=site-footer-item><a href=/presentations target=_blank>Slides</a></div><div class=site-footer-item><a href=/travel target=_blank>Travel</a></div><div class=site-footer-item><a href=https://joway.io target=_blank>About</a></div></div></div></div></article><script src=https://cdn.jsdelivr.net/gh/joway/blog/js/highlight.pack.js></script><script src=https://cdn.jsdelivr.net/gh/joway/blog/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById('article')});</script>